<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/static/styles/global.css">
    <link rel="stylesheet" href="/static/styles/board.css">
    <script type="text/javascript" src="/static/js/main.js"></script>
    <script type="text/javascript" src="/static/js/image_lazy_load.js"></script>
    <script type="text/javascript" src="/static/js/board_item.js"></script>
    <title>{{ board.title }}</title>
</head>
<body>
<div class="header">
    <a class="back-btn no-decor btn-bg-blend" href="{{ url_for('routes_board.view_board_all') }}">&lt;</a><h1>{{ board.title }}</h1>
</div>
<div id="board" class="board">
</div>
<script>

    let boardImages = {}
    let boardItems = {}

    function fetchImageData()
    {
        return fetch('{{ url_for("routes_board.get_board_images", b_id=board.id) }}').then(r =>
            {
                if (!r.ok) { throw new Error("Something went wrong, " + r.statusText) }
                return r.json()
            })
            .catch(err =>
            {
                console.log(err)
            })
    }

    // Save image position to the database
    function saveImageTransform(imageData)
    {
        const image = document.querySelector(`.image[data-id="${imageData.image_id}"]`)
        const strTr = JSON.stringify(imageData.tr)

        image.classList.remove('op-success', 'op-fail')
        return fetch(`{{ url_for('routes_board.set_board_image_transform') }}?b-id={{ board.id }}&image-id=${imageData.image_id}&tr=${strTr}`)
            .then(r =>
            {
                if (!r.ok) { throw new Error("Transform not saved") }
            })
            .catch(err =>
            {
                image.classList.add('op-fail')
                console.log(err)
            })
    }


    // Initialize the board
    function initializeBoard()
    {
        {#new BoardBoard()#}

        // Fetch image data from the database
        fetchImageData().then(imageData =>
        {
            // Render images on the board
            imageData.images.forEach(data =>
            {
                boardImages[data.image_id] = data
                boardItems[data.image_id] = new BoardImage(data)
            })
        })
    }

    // Initialize the board when the page loads
    document.addEventListener("DOMContentLoaded", initializeBoard)


    // hotkeys
    let isX = false
    let isS = false // study
    let isSpace = false // move board

    document.addEventListener('keydown', (e) =>
    {
        isX = e.code === 'KeyX'
        isS = e.code === 'KeyS'
        isSpace = e.code === 'Space'

        console.log(`sp d ${isSpace}`)
    })
    document.addEventListener('keyup', (e) =>
    {
        isX = !(e.code === 'KeyX') && isX
        isS = !(e.code === 'KeyS') && isS
        isSpace = !(e.code === 'Space') && isSpace

        console.log(`sp u ${isSpace}`)
    })

    // end hotkeys



</script>
</body>
</html>