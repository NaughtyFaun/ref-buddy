<!DOCTYPE html>
<html lang="en">
<head>
    <title>{{ title }}</title>
    <link rel="stylesheet" href="/static/styles_global.css">
    <link rel="stylesheet" href="/static/styles_gallery.css">
    <script type="text/javascript" src="/static/image_lazy_load.js"></script>
    <script type="text/javascript" src="/static/mut_attr_observer.js"></script>
</head>
<body>
<div class="header">
    <a class="back-btn no-decor btn-bg-blend" href="/">&lt;</a><h1>{{ title }}</h1>
    <p>[{{ overview.study_type|default('') }}]</p><p>{{ overview.path|default('') }}</p>

</div>
<div>{{ panel|default('') }}</div>
<div class="gallery">
    {% for image in images %}
    <div class="thumbnail" data-id="{{ image.image_id }}">
        <a href="/study-image/{{ image.image_id }}?same-folder=true&time-planned=120">
            <img class="thumb thumb-hidden" data-src="/thumb/{{ image.image_id }}.jpg" alt="{{ image.image_id }}">
            <div class="overlay vis-hide">
                <span class="tags-list"></span>
            </div>
        </a>

    </div>
    {% endfor %}
</div>

<div class="top-menu">
    <button id="rate-up" class="rate-up btn-bg-blend" value="1"></button>
    <button id="rate-dn" class="rate-dn btn-bg-blend" value="-1"></button>
    <button id="tags-show-btn" class="btn-bg-blend">Show tags</button>
    <button id="tags-open-btn" class="btn-bg-blend">Edit tags</button>
    <button id="toggle-selection-mode-btn" class="btn-bg-blend">Select</button>
</div>

<div class="tags-popup-background" style="display: none;"></div>
<div id="tags-popup" class="tags-popup" style="display: none;">
    <h3>Tags (<span id="images-count"></span> images selected)</h3>
    <div id="tagList" class="tag-container">
        <div class="tag-column">
        {% for t in tags %}
            <input type="checkbox" id="{{ t.tag }}" value="{{ t.tag }}"/>
            <label for="{{ t.tag }}">{{ t.tag }}</label><br>
            {% if loop.index % 10 == 0 %}
                </div><div class="tag-column">
            {% endif %}
        {% endfor %}
        </div>
    </div>
    <button id="tags-submit">Submit</button>
    <button id="tags-clear">Clear All</button>
    <button id="tags-close">Close</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function()
    {
        // reveal on load
        const thumbs = document.querySelectorAll('.thumb')
        thumbs.forEach((elem, idx) =>
        {
            new MutationAttributeObserver(elem, 'src', (target) =>
            {
                target.classList.remove('thumb-hidden')
            })
        })

        new ImageLazyLoad('.thumb', false, '300px')
    }, false)

    // Track the selection mode state
    let selectionMode = false;

    let selectedIds = []
    let lastClickedTile = null

    // Function to toggle the selection mode
    function toggleSelectionMode()
    {
        selectionMode = !selectionMode;

        // Add or remove event listeners and update UI based on selection mode state
        if (selectionMode)
        {
            document.querySelector('.gallery').classList.add('no-select')
            document.getElementById('toggle-selection-mode-btn').classList.add('select-mode-btn')

            // Disable other interactions and enable selection mode UI
            document.querySelectorAll('.thumbnail').forEach((tile) =>
            {
                tile.querySelector('a').classList.add('disabled')
                tile.addEventListener('click', onTileSelectionClick)

                const img = tile.querySelector('img')
                img.classList.remove('selected')
                img.classList.add('selectable')
            });
        }
        else
        {
            selectedIds = []

            document.querySelector('.gallery').classList.remove('no-select')
            document.getElementById('toggle-selection-mode-btn').classList.remove('select-mode-btn')

            // Enable other interactions and disable selection mode UI
            document.querySelectorAll('.thumbnail').forEach((tile) =>
            {
                tile.querySelector('a').classList.remove('disabled')
                tile.removeEventListener('click', onTileSelectionClick);

                const img = tile.querySelector('img')
                img.classList.remove('selectable')
                img.classList.remove('selected')
            });
        }
    }

    function onTileSelectionClick(event)
    {
        handleTileClick(event.currentTarget, false, event.shiftKey)
    }

    // Event handler for tile click during selection mode
    function handleTileClick(tile, isBatch=false, isShift=false)
    {
        const tileId = tile.getAttribute('data-id')

        if (isBatch && !selectedIds.includes(tileId))
        {
            selectedIds.push(tileId)
            const img = tile.querySelector('img')
            img.classList.add('selected');
        }
        else if (!isBatch && !selectedIds.includes(tileId))
        {
            selectedIds.push(tileId)
            const img = tile.querySelector('img')
            img.classList.add('selected');
        }
        else if (!isBatch && selectedIds.includes(tileId))
        {
            const idx = selectedIds.indexOf(tileId);
            if (idx !== -1) selectedIds.splice(idx, 1);
            const img = tile.querySelector('img')
            img.classList.remove('selected');
        }


        // stop when BATCH select
        if (isBatch) { return }

        if (isShift && lastClickedTile)
        {
            const dir = findSiblingDirection(lastClickedTile, tile)
            let getNextTile = cur => dir > 0 ? cur.nextElementSibling : cur.previousElementSibling
            let nextTile = getNextTile(lastClickedTile)
            while(nextTile != tile)
            {
                handleTileClick(nextTile, true)
                nextTile = getNextTile(nextTile)
            }
        }

        lastClickedTile = tile
    }

    function findSiblingDirection(elem1, elem2)
    {
        if (elem1 === elem2) { return 0 }

        let run = elem1
        while (run != null)
        {
            if (run === elem2) { return 1 }
            run = run.nextElementSibling
        }

        return -1
    }

    // Example usage: Toggle selection mode when a button is clicked
    document.getElementById('toggle-selection-mode-btn').addEventListener('click', toggleSelectionMode);
</script>

<!-- ################## -->
<!-- TAGS POPUP SECTION -->
<!-- ################## -->
<script>

    function toggleTagsPopupDisplay()
    {
        const btn = document.getElementById('tags-popup')
        if (btn.style.display === 'none')
        {
            btn.style.display = 'block'
            document.querySelector('.tags-popup-background').style.display = 'block'
            document.getElementById('images-count').textContent = '' + selectedIds.length
        }
        else
        {
            btn.style.display = 'none'
            document.querySelector('.tags-popup-background').style.display = 'none'
        }
    }

    {#function openTagsPopup()#}
    {#{#}
    {#    document.getElementById('tags-popup').style.display = 'block';#}
    {#    document.getElementById('images-count').textContent = '' + selectedIds.length;#}
    //}

    function closeTagsPopup()
    {
        document.getElementById('tags-popup').style.display = 'none';
        document.querySelector('.tags-popup-background').style.display = 'none'
    }

    function clearTagsPopup()
    {
        Array.from(document.querySelectorAll('#tagList input[type="checkbox"]:checked'))
            .map((checkbox) => checkbox.checked = false);
    }

    function submitAddTags()
    {
        const selectedTags = Array.from(document.querySelectorAll('#tagList input[type="checkbox"]:checked'))
            .map((checkbox) => checkbox.value);

        const idsStr = selectedIds.join(',')
        const tagsStr = selectedTags.join(',')

        {#const params = `image-id=${idsStr}&tags=${tagsStr}`#}
        {#console.log('Selected Tags:', params);#}

        document.getElementById('tags-submit').classList.add('loading-fav')

        fetch(`/add-image-tags?image-id=${idsStr}&tags=${tagsStr}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        document.getElementById('tags-submit').classList.remove('loading-fav')
                    })
                    .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                        document.getElementById('tags-submit').classList.remove('loading-fav')
                    });
    }

    function fetchTags()
    {
        const idsStr = Array.from(document.querySelectorAll('.thumbnail')).map((tile) => tile.getAttribute('data-id')).join(',')
        fetch(`/get-image-tags?image-id=${idsStr}`)
            .then(response => response.json())
            .then(data =>
            {
                if (!data) throw new Error('Network response was not ok')
                document.querySelectorAll('.thumbnail').forEach((tile) =>
                {
                    const id = tile.getAttribute('data-id')
                    tile.querySelector('.tags-list').textContent = data[id].join(', ')
                    tile.querySelector('.overlay').classList.remove('vis-hide')
                })
            })
            .catch(error =>
            {
                console.error('There was a problem with the fetch operation:', error)
            });
    }

    function rateImages(event)
    {
        if (selectedIds.length === 0) { return }

        const btn = event.currentTarget
        const value = btn.getAttribute('value')

        console.log(value)

        btn.classList.add('loading')
        btn.classList.remove('op-success', 'op-fail')

        const idsStr = selectedIds.join(',')
        fetch(`/add-mult-image-rating?image-id=${idsStr}&rating=${value}`)
            .then(response =>
            {
                if (!response.ok) { throw new Error('Network response was not ok') }
                btn.classList.add('op-success')
            })
            .catch(error =>
            {
                console.error('There was a problem with the fetch operation:', error)
                btn.classList.add('op-fail')
            })
            .finally(() =>
            {
                btn.classList.remove('loading')
            })
    }

    document.getElementById('rate-up').addEventListener('click', rateImages)
    document.getElementById('rate-dn').addEventListener('click', rateImages)
    document.getElementById('tags-show-btn').addEventListener('click', fetchTags)
    document.getElementById('tags-open-btn').addEventListener('click', toggleTagsPopupDisplay)
    document.getElementById('tags-submit').addEventListener('click', submitAddTags)
    document.getElementById('tags-close').addEventListener('click', closeTagsPopup)
    document.querySelector('.tags-popup-background').addEventListener('click', closeTagsPopup)
    document.getElementById('tags-clear').addEventListener('click', clearTagsPopup)

    document.addEventListener('keydown', function(e)
    {
        // select all
        if (selectionMode && e.code === 'KeyA' && e.shiftKey)
        {
            document.querySelectorAll('.thumbnail').forEach((tile) =>
            {
                handleTileClick(tile)
                lastClickedTile = null
            })
        }
        // toggle selection mode
        else if (e.code === 'KeyS' && !e.shiftKey)
        {
            toggleSelectionMode()
        }
        // toggle tag popup display
        else if (e.code === 'KeyT' && !e.shiftKey)
        {
            toggleTagsPopupDisplay()
        }
    });
</script>
</body>
</html>